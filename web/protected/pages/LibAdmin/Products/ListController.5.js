var PageJs=new Class.create;PageJs.prototype=Object.extend(new FrontPageJs,{htmlIDs:{totalCountDiv:"",listingDiv:"",showOrderBtn:"",orderSummaryDiv:"",showCartLink:""},pagination:{pageNo:1,pageSize:30},order:{},searchCriteria:{},setHTMLIDs:function(e,t,n,r,i){return this.htmlIDs.totalCountDiv=e,this.htmlIDs.listingDiv=t,this.htmlIDs.orderSummaryDiv=n,this.htmlIDs.showOrderBtn=r,this.htmlIDs.showCartLink=i,this},_orderProduct:function(e){var t={};return t.me=this,t.btn=e,t.product=t.btn.up(".prodcut-row").retrieve("data"),t.qty=$F(t.btn.up(".prodcut-row").down(".order-qty")),t.me.postAjax(t.me.getCallbackId("orderProduct"),{orderId:t.me.order.id,productId:t.product.id,qty:t.qty},{onLoading:function(){},onComplete:function(e,n){try{if(t.result=t.me.getResp(n,!1,!0),!t.result.order)return;t.me.order=t.result.order,t.me._displayOrderSummary(t.me.order)}catch(r){t.me.showModalBox("ERROR",r,!0)}}}),t.me},_getResultTableRow:function(e,t){var n={};return n.me=this,n.isTitle=t||!1,n.tag=n.isTitle===!0?"th":"td",n.img=n.isTitle===!0?"":new Element("a",{href:"javascript: void(0);"}).update(e.img).observe("click",function(){n.src=$(this).down("img").readAttribute("src"),jQuery.fancybox({type:"image",href:n.src,title:e.title})}),n.orderBtns=new Element("div",{"class":"input-group input-group-sm"}).insert({bottom:new Element("input",{"class":"form-control order-qty",type:"text",value:"1",style:"padding: 4px;"})}).insert({bottom:new Element("span",{"class":"input-group-btn"}).insert({bottom:new Element("span",{"class":"btn btn-success"}).update(new Element("span",{"class":"glyphicon glyphicon-plus"})).observe("click",function(){n.me._orderProduct(this)})})}),n.Qty=new Element("div").insert({bottom:new Element("div",{"class":"row"}).insert({bottom:new Element("strong",{"class":"col-xs-5"}).update("Has:")}).insert({bottom:new Element("div",{"class":"col-xs-3"}).update(e.qty)})}).insert({bottom:new Element("div",{"class":"row",title:(e.orderedLibs?e.orderedLibs.size():"")+" libraries ordered this item"}).insert({bottom:new Element("strong",{"class":"col-xs-5"}).update("Libs:")}).insert({bottom:new Element("a",{"class":"col-xs-3",href:"javascript: void(0);"}).update(e.orderedLibs?e.orderedLibs.size():"").observe("click",function(){0!==e.orderedLibs.size()&&(n.div=new Element("div").insert({bottom:n.list=new Element("div",{"class":"list-group",style:"min-width: 400px;"}).insert({bottom:new Element("div",{"class":"list-group-item active"}).update("Libraries that order this:"+e.title)})}),e.orderedLibs.each(function(e){n.list.insert({bottom:new Element("div",{"class":"list-group-item"}).update(e.name)})}),jQuery.fancybox({type:"html",content:n.div.innerHTML}))})})}),n.row=new Element("tr",{"class":"prodcut-row"}).store("data",e).insert({bottom:new Element(n.tag,{"class":"col-sm-1"}).update(n.img)}).insert({bottom:new Element(n.tag).update(e.title)}).insert({bottom:new Element(n.tag,{"class":"col-sm-2"}).update(e.isbn)}).insert({bottom:new Element(n.tag,{"class":"col-sm-1"}).update(e.author)}).insert({bottom:new Element(n.tag,{"class":"col-sm-1"}).update(e.publishDate)}).insert({bottom:new Element(n.tag,{"class":"col-sm-1"}).update(n.isTitle===!0?e.qty:n.Qty)}).insert({bottom:new Element(n.tag,{"class":"col-sm-1"}).update(n.isTitle===!0?"":n.orderBtns)}),n.row},_getLoadingDiv:function(){return new Element("span",{"class":"loading"}).insert({bottom:new Element("img",{src:"/images/loading.gif"})}).insert({bottom:"Loading ..."})},_getPaginationDiv:function(e){var t={};if(!(e.pageNumber>=e.totalPages))return t.me=this,new Element("div",{"class":"pagination_wrapper pull-right"}).insert({bottom:t.me._getPaginationBtn("查看更多 / 查看更多<br />Get more",e.pageNumber+1)})},changePage:function(e,t,n){this.pagination.pageNo=t,this.pagination.pageSize=n,$(e).update("Getting more ....").writeAttribute("disabled",!0),this.getResult(!1,function(){$(e).up(".pagination_wrapper").remove()})},_getPaginationBtn:function(e,t){var n={};return n.me=this,new Element("button",{"class":"btn btn-primary",type:"button"}).update(e).observe("click",function(){n.me.changePage(this,t,n.me.pagination.pageSize)})},searchProducts:function(e){var t={};return t.me=this,t.searchPanel=$(e).up(".search-panel").getElementsBySelector("[search-panel]").each(function(e){t.me.searchCriteria[e.readAttribute("search-panel")]=$F(e)}),t.me.getResult(!0),t.me},getResult:function(e,t){var n={};return n.me=this,n.reset=e||!1,n.me.postAjax(n.me.getCallbackId("getItems"),{pagination:n.me.pagination,searchCriteria:n.me.searchCriteria},{onLoading:function(){n.reset===!0&&(n.me.pagination.pageNo=1,$(n.me.htmlIDs.listingDiv).update(n.me.getLoadingImg()))},onComplete:function(e,r){try{if(n.result=n.me.getResp(r,!1,!0),!n.result.items)return;n.reset===!0&&($(n.me.htmlIDs.listingDiv).update(new Element("table",{"class":"table table-striped table-hover"}).insert({bottom:new Element("thead").update(n.me._getResultTableRow({title:"Name",isbn:"ISBN",qty:"Qty",author:"Author",publishDate:"Publish Date"},!0))}).insert({bottom:n.tbody=new Element("tbody")})),$(n.me.htmlIDs.totalCountDiv).update(n.result.pagination.totalRows)),n.result.items.each(function(e){n.item={id:e.id,title:e.title,isbn:e.attributes.isbn?e.attributes.isbn[0].attribute:"",img:n.me._getProductImgDiv(e.attributes.image_thumb||null,{style:"height: 50px; width:auto;"}),author:e.attributes.author?e.attributes.author[0].attribute:"",publishDate:e.attributes.publish_date?e.attributes.publish_date[0].attribute:"",qty:e.orderedQty,orderedLibs:e.orderedLibs},$(n.me.htmlIDs.listingDiv).down("tbody").insert({bottom:n.me._getResultTableRow(n.item,!1)})}),$(n.me.htmlIDs.listingDiv).insert({bottom:n.me._getPaginationDiv(n.result.pagination)})}catch(i){$(n.me.htmlIDs.listingDiv).update(n.me.getAlertBox("Error: ",i).addClassName("alert-danger"))}"function"==typeof t&&t()}}),n.me},_displayOrderSummary:function(e){var t={};return t.me=this,$(t.me.htmlIDs.orderSummaryDiv).update(""),e.items.reverse().each(function(e){$(t.me.htmlIDs.orderSummaryDiv).insert({bottom:new Element("a",{"class":"list-group-item"}).insert({bottom:e.product.title}).insert({bottom:new Element("span",{"class":"badge"}).update(e.qty)})})}),t.me},_openDetailsPage:function(e){var t={};return t.me=this,jQuery.fancybox({width:"95%",height:"95%",autoScale:!1,autoDimensions:!1,fitToView:!1,autoSize:!1,type:"iframe",href:"/libadmin/order/"+e.id+".html",beforeClose:function(){t.order=$$("iframe.fancybox-iframe").first().contentWindow.pageJs._order,t.order&&"OPEN"!==t.order.status?window.location=document.URL:(t.me.order=t.order,t.me._displayOrderSummary(t.me.order))}}),t.me},setLanguages:function(e,t){var n={};return n.me=this,n.me.langs=t,$(e).insert({bottom:new Element("option",{value:""}).update("ALL")}),n.me.langs.each(function(t){$(e).insert({bottom:new Element("option",{value:t.id}).update(t.name)})}),n.me},setCategories:function(e,t){var n={};return n.me=this,n.me.cates=t,n.me.cates&&0!==n.me.cates.size()?(n.me.cates.each(function(t){$(e).insert({bottom:new Element("option",{value:t.id}).update(t.path)})}),n.me):n.me},bindChosen:function(){var e={};return e.me=this,jQuery(".chosen").chosen({disable_search_threshold:10,no_results_text:"Oops, nothing found!","class":"form-control"}),e.me},getOrderSummary:function(){var e={};return e.me=this,e.me.postAjax(e.me.getCallbackId("getOrderSummary"),{},{onLoading:function(){},onComplete:function(t,n){try{if(e.result=e.me.getResp(n,!1,!0),!e.result.order)return;e.me.order=e.result.order,e.me._displayOrderSummary(e.me.order),$(e.me.htmlIDs.showCartLink).observe("click",function(){e.me._openDetailsPage(e.me.order)}),$(e.me.htmlIDs.showOrderBtn).insert({bottom:new Element("span",{"class":"btn btn-success btn-sm"}).update("Checkout").observe("click",function(){e.me._openDetailsPage(e.me.order)})})}catch(r){e.me.showModalBox("ERROR",r,!0)}}}),e.me}});